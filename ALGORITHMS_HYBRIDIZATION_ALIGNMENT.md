# 杂化轨道自适应对齐算法 (Adaptive Hybridization Alignment)

## 1. 背景与问题
在计算杂化轨道（如 $sp^3d, sp^3d^2$）时，我们需要两个输入：
1.  **几何构型 (Geometry)**：一组代表杂化方向的单位向量 $\{\vec{v}_1, ..., \vec{v}_N\}$。
2.  **原子轨道基组 (Basis Set)**：一组物理波函数 $\{\phi_1, ..., \phi_N\}$ (如 $s, p_z, d_{z^2}$)。

**核心冲突**：
*   **几何构型的随机性**：我们使用的 Thomson 算法（电子斥力最小化）生成的几何构型是各向同性的，其整体取向是**随机的**。例如，它可能生成一个“躺着”的三角双锥。
*   **基组的各向异性**：部分基组（如仅包含 $d_{z^2}$ 而不包含其他 $d$ 轨道）具有极强的方向敏感性。$d_{z^2}$ 只能沿 Z 轴提供 $d$ 成分。

如果随机生成的三角双锥的轴向没有对齐到 Z 轴，现有的 SVD 算法会试图强行用 $s, p$ 轨道去拟合轴向波函数，导致物理意义丧失（成分分配错误、形状扭曲）。

## 2. 算法核心原理：最大投影体积 (Maximal Projection Volume)

我们的目标是寻找一个旋转矩阵 $R$，使得旋转后的几何构型与基组最匹配。
我们定义的“匹配度”为**基组在几何点上的投影矩阵的体积（行列式）**。

### 2.1 数学表述

定义投影矩阵 $A(R)$，维度为 $N \times N$：
$$ A_{ij}(R) = \phi_j(R \cdot \vec{v}_i) $$
其中：
*   $R \cdot \vec{v}_i$ 是旋转后的第 $i$ 个几何点。
*   $\phi_j$ 是第 $j$ 个原子轨道的波函数（实球谐函数值）。

我们的目标函数 $J(R)$ 是矩阵 $A$ 的**广义体积**：
$$ J(R) = \det(\sqrt{A^T A}) = \prod_{k=1}^N \sigma_k(A) $$
其中 $\sigma_k$ 是 $A$ 的奇异值。

### 2.2 物理意义
*   **若 $\det \approx 0$**：说明几何点落在了基组的“盲区”（节面）上，或者基组无法线性组合出该几何构型（如试图用 $s, p_x$ 组合出 Y 轴方向）。
*   **若 $\det$ 最大**：说明几何点落在了基组波函数幅度最大的方向（Lobe 方向），此时基组能以最高的效率（最小的系数范数）生成目标杂化轨道。

## 3. 算法流程 (Implementation Pipeline)

### 第一步：生成初始构型 (Thomson Problem)
使用静电斥力模型生成 $N$ 个分布均匀的单位向量 $\vec{v}^{init}_i$。此构型是“完美形状”但“随机朝向”。

### 第二步：全局寻优对齐 (Optimization)
这是一个低维优化问题（3个自由度：欧拉角 $\alpha, \beta, \gamma$ 或四元数）。

1.  **定义惩罚函数 (Cost Function)**:
    $$ Cost(R) = -\sum_{k=1}^N \log(\sigma_k(A(R)) + \epsilon) $$
    使用对数和代替乘积以提高数值稳定性。

2.  **搜索策略 (Random Restart Hill Climbing)**:
    由于目标函数可能存在局部极值（对应不同的对称取向），我们采用多点启动策略。
    *   随机生成 $K$ 个（如 20 个）初始旋转 $R_0$。
    *   对每个 $R_0$ 进行简单的梯度下降或爬山搜索。
    *   记录 Score 最高的那个旋转 $R_{best}$。

### 第三步：应用旋转与正交化 (Apply & SVD)
1.  计算最佳对齐点：$\vec{v}^{final}_i = R_{best} \cdot \vec{v}^{init}_i$
2.  构建最终矩阵 $A_{final}$。
3.  进行 Loewdin 正交化 (Symmetric Orthogonalization) 得到杂化系数矩阵 $C$：
    $$ A = U \Sigma V^T $$
    $$ C = U V^T $$
    *(注：这里 $C$ 的行即为杂化轨道，列为原子轨道)*

## 4. 优势分析
1.  **通用性 (Universal)**：不需要为 $sp^3d$ 或 $sp^3d^2$ 编写特定的硬编码规则。算法自动理解 $d_{z^2}$ 需要 Z 轴，$d_{x^2-y^2}$ 需要 X/Y 轴。
2.  **容错性 (Robust)**：能够检测“不可能的杂化”（如用 $p_x, p_y$ 杂化成直线型），此时 $\det \to 0$。
3.  **自适应性**: 如果用户输入了奇怪的组合（如 $s + d_{xy}$），算法会自动将构型旋转到 $XY$ 平面的对角线上，而不需要人工干预。
