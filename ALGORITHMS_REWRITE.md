# 电子云可视化：物理原理与算法详解

本文档面向希望深入理解本项目物理基础的用户，系统阐述原子轨道可视化背后的量子力学原理、数值方法与算法实现。

> **适用范围声明**  
> 本项目可视化的对象是**孤立原子在基态下的原子轨道**——即单个原子中电子的空间分布概率。这与分子轨道、化学键、晶体场下的轨道有本质区别。对于氢原子，我们使用 Schrödinger 方程的精确解析解；对于多电子原子（He 至 Lr，Z=2–103），我们采用高精度数值 Hartree-Fock 波函数。

---

## 1. 氢原子：量子力学的精确解

### 1.1 为什么氢原子如此特殊？

氢原子是自然界中最简单的原子体系：一个质子和一个电子通过库仑力相互作用。这种两体问题在量子力学中具有精确解析解，这是极其罕见的——绝大多数量子系统只能通过数值方法近似求解。

氢原子的 Schrödinger 方程为：

$$
\hat{H}\psi = E\psi \quad \text{其中} \quad \hat{H} = -\frac{\hbar^2}{2m_e}\nabla^2 - \frac{Ze^2}{4\pi\varepsilon_0 r}
$$

由于哈密顿量具有球对称性，在球坐标 $(r, \theta, \phi)$ 下可进行**分离变量**，将波函数写为径向部分与角向部分的乘积：

$$
\psi_{nlm}(r, \theta, \phi) = R_{nl}(r) \cdot Y_l^m(\theta, \phi)
$$

这一分解不仅简化了数学处理，更揭示了物理本质：电子在原子中的"距离分布"（径向）与"方向分布"（角向）可以独立描述。

### 1.2 径向波函数：电子离核多远？

径向波函数 $R_{nl}(r)$ 描述电子在不同距离 $r$ 处的概率振幅。其解析表达式为：

$$
R_{nl}(r) = \underbrace{\sqrt{\left(\frac{2Z}{na_0}\right)^3 \frac{(n-l-1)!}{2n \cdot (n+l)!}}}_{\text{归一化因子}} \cdot \underbrace{e^{-\rho/2}}_{\text{指数衰减}} \cdot \underbrace{\rho^l}_{\text{角动量因子}} \cdot \underbrace{L_{n-l-1}^{2l+1}(\rho)}_{\text{Laguerre 多项式}}
$$

**各部分的物理含义**：

1. **归一化因子**：确保 $\int_0^\infty |R_{nl}|^2 r^2 dr = 1$，即电子一定存在于某处
2. **指数衰减** $e^{-\rho/2}$：电子被束缚在原子核附近，远离核时概率指数下降
3. **角动量因子** $\rho^l$：角动量越大（$l$ 越大），电子越"远离"原子核——这是"离心势垒"的量子力学体现
4. **Laguerre 多项式**：引入径向节点（$n-l-1$ 个），决定波函数在不同距离的振荡结构

其中无量纲变量 $\rho = 2Zr/(na_0)$，$a_0 = 0.529$ Å 是 Bohr 半径。本项目采用原子单位制，取 $a_0 = 1$。

**广义 Laguerre 多项式**的递推求和公式：

$$
L_k^\alpha(x) = \sum_{i=0}^{k} (-1)^i \binom{k+\alpha}{k-i} \frac{x^i}{i!}
$$

实现时直接按此公式计算，无需递归。

> **参考文献**：D.J. Griffiths, *Introduction to Quantum Mechanics*, 3rd ed. (Cambridge, 2018), §4.2

### 1.3 径向概率密度：电子最可能在哪里？

波函数本身不是可观测量，但其模方 $|R_{nl}|^2$ 与概率密度相关。特别地，**径向分布函数**定义为：

$$
P(r) = r^2 |R_{nl}(r)|^2
$$

这里的 $r^2$ 因子来自球坐标的体积元 $dV = r^2 \sin\theta\, dr\, d\theta\, d\phi$。$P(r)\,dr$ 给出电子在半径 $[r, r+dr]$ 的球壳内出现的概率。

$P(r)$ 的峰值位置称为"最可几半径"，但通常与 Bohr 模型的轨道半径 $n^2 a_0/Z$ 不完全相同——后者对应电子期望半径 $\langle r \rangle$，而非最可几位置。

### 1.4 角向波函数：轨道的"形状"

角向波函数 $Y_l^m(\theta, \phi)$ 决定了我们熟悉的轨道形状——s 轨道的球形、p 轨道的哑铃形、d 轨道的四叶草形等。

#### 复球谐函数与实球谐函数

量子力学教科书中通常使用**复球谐函数**，其形式为：

$$
Y_l^m(\theta, \phi) = N_{lm} P_l^{|m|}(\cos\theta) e^{im\phi}
$$

其中 $P_l^m$ 是连带 Legendre 多项式，$N_{lm}$ 是归一化系数。

然而，化学中习惯使用**实球谐函数**，这是因为：
1. 实函数更直观——可以讨论"正相位"和"负相位"区域
2. 与化学键方向性直接对应——$p_x$ 指向 $x$ 轴，$d_{xy}$ 在 $xy$ 平面

实球谐函数通过复球谐函数的线性组合定义：

$$
Y_{l,m}^{\text{cos}} = \frac{1}{\sqrt{2}}\left[Y_l^{-m} + (-1)^m Y_l^{m}\right] \propto P_l^m(\cos\theta)\cos(m\phi)
$$
$$
Y_{l,m}^{\text{sin}} = \frac{i}{\sqrt{2}}\left[Y_l^{-m} - (-1)^m Y_l^{m}\right] \propto P_l^m(\cos\theta)\sin(m\phi)
$$

这给出了熟悉的轨道：
- $p_x = Y_{1,1}^{\text{cos}}$，$p_y = Y_{1,1}^{\text{sin}}$，$p_z = Y_1^0$
- $d_{xy} = Y_{2,2}^{\text{sin}}$，$d_{x^2-y^2} = Y_{2,2}^{\text{cos}}$，$d_{z^2} = Y_2^0$

#### Condon-Shortley 相位惯例

球谐函数的符号惯例历来存在分歧。本项目采用 **Condon-Shortley 惯例**，其特征是在连带 Legendre 多项式中引入 $(-1)^m$ 因子（对于 $m > 0$）。这确保了：
- $p_x$ 在 $x > 0$ 区域为正
- $d_{xy}$ 在第一象限为正

这与大多数化学教科书一致。代码中通过 `csPhaseCorrection = (mm % 2 === 1) ? -1 : 1` 实现。

> **参考文献**：E.U. Condon & G.H. Shortley, *The Theory of Atomic Spectra* (Cambridge, 1935)

### 1.5 量子数的物理意义

| 量子数 | 符号 | 取值范围 | 物理意义 |
|--------|------|----------|----------|
| 主量子数 | $n$ | 1, 2, 3, ... | 能级与轨道大小 |
| 角量子数 | $l$ | 0 ~ $n-1$ | 轨道角动量 $L = \sqrt{l(l+1)}\hbar$ |
| 磁量子数 | $m$ | $-l$ ~ $l$ | 角动量在 $z$ 轴的投影 $L_z = m\hbar$ |

轨道名称对应关系：$l=0 \to s$，$l=1 \to p$，$l=2 \to d$，$l=3 \to f$。

---

## 2. 多电子原子：数值近似方法

### 2.1 多电子问题的复杂性

一旦原子中包含两个或更多电子，精确解析解就不再存在。这是因为电子之间存在库仑排斥：

$$
\hat{H} = \sum_i \left[-\frac{\hbar^2}{2m_e}\nabla_i^2 - \frac{Ze^2}{r_i}\right] + \sum_{i<j} \frac{e^2}{r_{ij}}
$$

最后一项——电子-电子排斥——使方程无法分离变量。因此，所有多电子原子的波函数都必须通过近似方法求解。

### 2.2 Hartree-Fock 方法简介

本项目采用的波函数来自 **Hartree-Fock (HF)** 方法，这是处理多电子系统最基础也最重要的近似之一。其核心思想是：

1. **独立粒子近似**：假设每个电子在其他所有电子产生的"平均场"中运动
2. **Slater 行列式**：用反对称化的乘积态（Slater 行列式）描述 $N$ 个电子，自动满足泡利不相容原理
3. **自洽场 (SCF)**：通过迭代求解，直到输入的平均场与输出的电子密度自洽

HF 方法给出的是**最佳单行列式波函数**——在所有可能的单 Slater 行列式中，它的能量最低。这个能量称为 **Hartree-Fock 极限**。

### 2.3 Slater 型轨道基组

在 HF 计算中，需要选择一组基函数来展开分子/原子轨道。本项目使用 **Slater 型轨道 (STO)** 基组：

$$
\chi(r) = N \cdot r^{n^*-1} \cdot e^{-\zeta r}
$$

与 Gaussian 型轨道 (GTO) 相比，STO 更接近真实氢原子波函数的形式：
- **核尖峰**：STO 在 $r \to 0$ 时有正确的 cusp 行为
- **指数衰减**：STO 在大 $r$ 时的衰减行为正确

但 STO 的多中心积分困难，限制了其在分子计算中的应用。对于原子计算，这不是问题。

### 2.4 Koga 高精度基组

本项目采用 **Koga 等人开发的高精度 STO 基组**，这是目前可用于原子 Hartree-Fock 计算精度最高的基组之一。特别注意，这个基组是非相对论的，无法展示相对论效应。

**每个轨道的径向函数**表示为多个 STO 的线性组合：

$$
R_{nl}(r) = \sum_{i=1}^{N} c_i \cdot \chi_i(r) = \sum_{i=1}^{N} c_i \cdot N_i \cdot r^{n_i^*-1} \cdot e^{-\zeta_i r}
$$

**基组参数说明**：

| 参数 | 含义 | 特点 |
|------|------|------|
| $c_i$ | 展开系数 | 通过能量变分优化 |
| $n_i^*$ | 有效主量子数 | 可为非整数，增加灵活性 |
| $\zeta_i$ | 轨道指数 | 控制径向衰减速率 |

典型的原子轨道需要 3–8 个 STO 项来精确描述。例如，碳原子的 2p 轨道可能需要 5 个具有不同 $\zeta$ 值的 STO 线性组合。

**数据来源**：
- Z = 1–54 (H–Xe)：Koga et al., *Theor. Chem. Acc.* **104**, 411 (2000)

### 2.5 基组精度验证

Koga 基组达到数值 Hartree-Fock 极限精度。以下是部分原子的验证数据：

| 原子 | 总能量 (Hartree) | NIST 参考值 | 误差 |
|------|------------------|-------------|------|
| He | −2.8617 | −2.8617 | <10⁻⁴ |
| C | −37.6886 | −37.6886 | <10⁻⁴ |
| Fe | −1262.4436 | −1262.4436 | <10⁻⁴ |

### 2.6 相位校正的必要性

Koga 基组的系数是通过数值优化得到的，其整体相位（正负号）是任意的。但在可视化中，我们需要确保相位与化学惯例一致：

- 2p 轨道在正轴方向应为正
- 相邻壳层的节点结构应正确交替

**校正算法**：

1. 确定氢原子解析解在**外区**（大 $r$）的符号：$\text{sign}_{\text{H}} = (-1)^{n-l-1}$
2. 在 STO 展开中，找到**衰减最慢**的项（最小 $\zeta_i$），它主导外区行为
3. 若主导项系数的符号与 $\text{sign}_{\text{H}}$ 不一致，翻转整个波函数

这确保了所有原子的轨道具有一致的相位惯例。

---

## 3. 轨道能量的物理意义

### 3.1 什么是轨道能量？

在 Hartree-Fock 框架中，每个轨道 $\phi_i$ 对应一个**轨道能量** $\varepsilon_i$：

$$
\hat{F}\phi_i = \varepsilon_i \phi_i
$$

其中 $\hat{F}$ 是 Fock 算符，包含电子的动能、核吸引势和平均电子排斥势。

$\varepsilon_i$ 可以理解为：**将一个电子放入轨道 $\phi_i$ 所需的能量**，包含了与其他电子的平均相互作用。

### 3.2 Koopmans 定理

Koopmans 定理指出，在 frozen orbital 近似下：

$$
\text{电离能} \approx -\varepsilon_i
$$

即，从占据轨道 $\phi_i$ 移除一个电子所需的能量约等于该轨道能量的负值。

**适用条件与局限**：
- 对**价层轨道**：近似较好（误差通常 < 1 eV）
- 对**内层轨道**：误差可达数 eV，因为忽略了弛豫效应

本项目存储的轨道能量 $\varepsilon_i$ 直接来自 Koga 基组的 Hartree-Fock 计算结果。

### 3.3 氢原子的精确能量

对于氢原子（及类氢离子），能量有精确解析表达式：

$$
E_n = -\frac{Z^2}{2n^2} \text{ Hartree} = -\frac{13.606 \, \text{eV}}{n^2}
$$

关键特征：
- 能量**只依赖主量子数** $n$，与 $l$、$m$ 无关（简并）
- 这是纯库仑势的特殊性质，多电子原子中简并被破缺

### 3.4 累积能量曲线的可视化

界面中的"累积能量曲线" $E(R)$ 展示了轨道能量的空间分布：

$$
E(R) = \int_0^R \varepsilon \cdot P(r) \, dr = \varepsilon \cdot \int_0^R r^2 |R_{nl}(r)|^2 \, dr
$$

**物理解释**：
- $E(R)$ 表示"半径 $R$ 以内区域对总轨道能量的贡献"
- 当 $R \to \infty$ 时，$E(\infty) = \varepsilon$（因为概率归一化）
- 曲线的斜率 $dE/dr = \varepsilon \cdot P(r)$ 反映不同距离处的能量密度

这种可视化揭示了一个直观事实：虽然轨道能量是全局性质，但不同空间区域的"贡献"不同——内层电子（小 $r$）贡献更多负能量。

---

## 4. 蒙特卡洛采样：从概率密度到电子云

### 4.1 采样问题的本质

可视化电子云的核心挑战是：**如何从三维概率密度 $|\psi(r,\theta,\phi)|^2$ 中生成代表性采样点？**

直接拒绝采样效率极低——对于高 $n$ 轨道，体积巨大而电子密度集中在小区域。我们需要更智能的方法。

### 4.2 分离变量策略

利用波函数的分离结构：

$$
|\psi|^2 = |R_{nl}(r)|^2 \cdot |Y_l^m(\theta, \phi)|^2
$$

可以将三维采样分解为**独立的径向采样**和**角向采样**，然后组合结果。这大大简化了问题。

### 4.3 径向采样：逆 CDF 方法

**问题**：从径向分布 $P(r) = r^2 |R_{nl}(r)|^2$ 采样。

**方法**：累积分布函数 (CDF) 反演。这是一种经典技术，核心思想是：

1. 计算 CDF：$F(r) = \int_0^r P(r') dr'$
2. 生成均匀随机数 $u \in [0,1)$
3. 求解 $r$ 使得 $F(r) = u$

**实现细节**：

由于 $F^{-1}$ 没有解析形式，我们使用**数值方法**：

1. **预计算 CDF 表**：
   - 使用 2000 个等距网格点覆盖 $[0, r_{\max}]$
   - $r_{\max} = \max(4n^2 a_0, 50a_0)$，确保覆盖 99.9%+ 概率
   - 使用梯形法则数值积分

2. **二分查找 + 线性插值**：
   - 给定 $u$，二分查找最近的 CDF 值
   - 在相邻网格点间线性插值获得精确 $r$

**优势**：
- **100% 接受率**：无拒绝采样，每次调用都产生有效样本
- **高速**：预计算后，每次采样仅需 O(log N) 查找

### 4.4 角向采样：重要性采样

**问题**：从 $|Y_l^m(\theta, \phi)|^2$ 采样 $(\theta, \phi)$。

**方法**：从均匀球面分布采样，再用接受-拒绝校正。

**均匀球面采样**的正确方式：
$$
\cos\theta \sim U[-1, 1], \quad \phi \sim U[0, 2\pi)
$$

这给出"面积均匀"分布——单位球面上每个方向的概率相等。

**接受-拒绝步骤**：
1. 计算权重 $w = 4\pi |Y_l^m(\theta, \phi)|^2$
2. 若 $u \cdot w_{\max} < w$，接受；否则拒绝重采

**权重上界**的推导：

球谐函数满足归一化条件 $\int |Y_l^m|^2 d\Omega = 1$，因此平均值是 $1/(4\pi)$，权重平均值是 1。

最大值可以证明：
- $m = 0$：$w_{\max} \approx 2l + 1$
- $m \neq 0$：$w_{\max} \approx 2(2l + 1)$

实现中加入 10–20% 安全边际。

**接受率**：
- s 轨道：100%（各向同性）
- p 轨道：~50%
- d 轨道：~33%

虽然不是 100%，但仍远优于全三维拒绝采样。

---

## 5. 杂化轨道：几何与代数

### 5.1 杂化的物理动机

在分子中，原子轨道需要"指向"成键方向以形成有效重叠。但原子轨道的固有方向（如 $p_z$ 沿 $z$ 轴）往往与分子几何不匹配。

**杂化**是一种数学变换：将若干原子轨道线性组合，产生一组**等价的、指向特定方向**的新轨道。经典例子：

- **sp³**：s + 3p → 4 个等价轨道，指向正四面体顶点（甲烷 CH₄）
- **sp²**：s + 2p → 3 个等价轨道，在平面内呈 120°（乙烯 C₂H₄）
- **sp**：s + p → 2 个等价轨道，呈 180°（乙炔 C₂H₂）

### 5.2 为什么限制构型？

杂化不是任意的线性组合。要产生**等价且正交**的杂化轨道，必须满足群论约束。本项目仅支持：

| 杂化类型 | 对称性 | 轨道数 | 几何 |
|----------|--------|--------|------|
| sp | D∞h | 2 | 直线 |
| sp² | D3h | 3 | 平面三角 |
| sp³ | Td | 4 | 正四面体 |
| sp³d | D3h | 5 | 三角双锥 |
| sp³d² | Oh | 6 | 正八面体 |

其他组合（如 p + p，或 s + d）通常不能形成对称等价的轨道集。

### 5.3 约束与自由度

**构型约束**（不可违反）：

仅允许 sp、sp²、sp³、sp³d、sp³d² 构型。其他轨道组合（如 p+p 或 s+d）无法产生对称等价的杂化轨道，系统拒绝计算。

**能层自由度**（可自由选择）：

参与杂化的轨道可来自不同能层（如 2s + 3p 构成 sp）。系统对此不做限制。

**跨能层杂化的严谨性**：

- **数学正确**：SVD Procrustes 算法对任意输入轨道均产生正交归一的系数矩阵
- **波函数正确**：输出的杂化轨道仍满足正交性和归一化条件
- **物理可观察**：可视化真实反映该线性组合的概率密度分布

跨能层杂化的结果通常呈现**径向尺度失配**——不同能层轨道的空间范围差异导致杂化轨道在空间分布上不对称，不具备教科书中"等价轨道"的性质。这解释了为什么实际化学中杂化默认采用同能层轨道。

### 5.4 杂化系数的计算

**问题描述**：

给定 $N$ 个原子轨道 $\{\psi_j\}$ 和 $N$ 个目标方向 $\{\hat{d}_i\}$，求系数矩阵 $C$ 使得：

$$
\psi_{\text{hybrid},i} = \sum_{j=1}^N C_{ij} \cdot \psi_j
$$

满足：
1. **正交性**：$\langle \psi_{\text{hybrid},i} | \psi_{\text{hybrid},k} \rangle = \delta_{ik}$
2. **方向性**：$\psi_{\text{hybrid},i}$ 的主瓣指向 $\hat{d}_i$

**数学形式化**：

构建**方向-轨道耦合矩阵**：
$$
A_{ij} = Y_j(\theta_i, \phi_i)
$$

其中 $Y_j$ 是第 $j$ 个原子轨道的角向部分，$(\theta_i, \phi_i)$ 是方向 $\hat{d}_i$ 的球面坐标。

$A_{ij}$ 的物理意义：原子轨道 $j$ 在方向 $i$ 上的"投影强度"。

正交性约束意味着寻找最接近 $A$ 的**正交矩阵** $C$：
$$
C = \arg\min_{C^T C = I} \| A - C \|_F
$$

这是经典的 **正交 Procrustes 问题**。

**SVD 求解**：

对 $A$ 进行奇异值分解：$A = U \Sigma V^T$

则最优解为：
$$
C = U V^T
$$

这个解优雅地同时满足正交性和最佳匹配条件。

> **参考文献**：G.H. Golub & C.F. Van Loan, *Matrix Computations*, 4th ed. (2013), §12.4

---

## 6. 等值面可视化

### 6.1 什么是等值面？

等值面是三维标量场中**值恒定的曲面**。对于波函数 $\psi(\mathbf{r})$，等值面 $\psi = c$ 包围了波函数"强度"超过阈值的区域。

在化学中，我们通常显示 $|\psi|^2 = c$ 的等值面，表示电子密度超过某阈值的空间区域。调节 $c$ 可以控制显示的"轮廓线"——小 $c$ 显示更大范围，大 $c$ 显示核心区域。

### 6.2 Marching Cubes 算法

Marching Cubes 是计算等值面的标准算法，由 Lorensen 和 Cline 于 1987 年发明。

**核心思想**：

1. 将空间划分为规则的立方体网格
2. 在每个立方体的 8 个顶点评估标量场值
3. 根据顶点值与阈值的比较，确定等值面如何穿过该立方体
4. 使用查找表生成三角形面片

**256 种情况**：

每个顶点要么"高于"要么"低于"阈值，$2^8 = 256$ 种组合。通过预计算的 `TRI_TABLE`，可以快速确定每种情况对应的三角形配置。

**边插值**：

当等值面穿过立方体的某条边时，精确位置通过线性插值计算：
$$
t = \frac{c - v_1}{v_2 - v_1}, \quad \mathbf{p} = (1-t)\mathbf{p}_1 + t\mathbf{p}_2
$$

### 6.3 连通域分离与相位着色

对于 p、d、f 轨道，波函数有正负之分。等值面 $\psi = +c$ 和 $\psi = -c$ 分别包围正相位和负相位区域。

**分离算法**（并查集）：
1. 每个三角形初始为独立集合
2. 共享边的三角形合并到同一集合
3. 最终得到若干独立的"岛屿"

分离后，可以用不同颜色（如蓝/红）渲染正负相位区域，直观展示波函数的节点结构。

---

## 7. 精度边界与适用范围

本项目的物理边界可总结如下：

| 方面 | 本项目方法 | 精度 | 局限 |
|------|------------|------|------|
| **适用体系** | 孤立原子基态 | — | 不适用于分子、激发态 |
| **氢原子** | 解析解 | 精确 | — |
| **多电子原子** | Koga STO + HF | 数值 HF 极限 | 无电子关联 |
| **轨道能量** | 存储 HF 本征值 | 精确（HF 意义下） | 电离能需 Koopmans 近似 |
| **杂化** | SVD Procrustes | 最优正交解 | 仅限标准构型 |
| **采样** | 逆 CDF + 拒绝 | 无偏 | 有限样本统计噪声 |
| **等值面** | Marching Cubes | 离散化精度 | 网格分辨率限制 |

对于教育和演示目的，这些精度完全足够。对于研究级应用，应使用专业量子化学软件。
