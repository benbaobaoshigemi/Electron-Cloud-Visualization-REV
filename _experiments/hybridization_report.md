# 杂化轨道算法分析报告

**日期**: 2025-12-28
**分析对象**: `physics.js` / `physics-core.js` 中的 `getHybridCoefficients` 及相关逻辑
**测试案例**: Pure pz, pz+px, sp3, sp3d, sp3d2

## 1. 核心问题总结

目前的杂化算法基于 **Thomson 优化点 + SVD 正交化**。这种方法在处理各向同性的全壳层基组（如 $sp^3$）时效果良好，但在处理非各向同性的部分基组（如 $sp^3d$ 的 $dz^2$）时存在严重缺陷，导致轨道指向混乱和成分分配错误。

**结论**：`sp3d` 和 `sp3d2` 的杂化结果在当前算法下是物理上不可靠的。

## 2. 详细案例分析

### 2.1. 正常案例：sp3 (Tetrahedral)
*   **输入**: $s, p_z, p_x, p_y$
*   **结果**:
    *   s 成分：所有 4 个轨道均为 25.0% (完美)。
    *   p 成分：所有 4 个轨道均为 75.0% (完美)。
    *   指向：形成四面体结构。
*   **原因**: 输入包含了完整的 $p$ 壳层（$p_x, p_y, p_z$）。这意味着基组在旋转下是闭合的（各向同性）。无论 Thomson 优化生成的四面体如何旋转，该基组都能通过线性组合完美生成指向顶点的波函数。

### 2.2. 失败案例：sp3d (Trigonal Bipyramidal)
*   **输入**: $s, p_z, p_x, p_y, d_{z^2}$
*   **预期**: 
    *   三角双锥 (TBP) 构型。
    *   轴向 (Axial) 键主要由 $p_z, d_{z^2}$ 贡献。
    *   赤道 (Equatorial) 键由 $s, p_x, p_y$ 贡献（在某些模型中）。
*   **实测结果**:
    *   **指向混乱**: 轨道没有形成严格的轴向/赤道区分。虽然可以找到大致的形状，但角度不精确。
    *   **成分离散**: 
        *   轨道 d 成分波动极大：0.1% 到 40.0% 不等。
        *   某个轨道变成了纯 sp 杂化（0.1% d），而另一个轨道拿走了 40% 的 d。
*   **根本原因**:
    *   **基组各向异性**: 我们只选择了 $d_{z^2}$，而没有选其他 d 轨道。$d_{z^2}$ 具有很强方向性（沿 Z 轴）。
    *   **目标旋转随机性**: `optimizeThomson` 生成的 TBP 结构是随机旋转的。如果 TBP 的轴向不与 Z 轴重合，现有的基组（缺 $d_{xz}, d_{yz}$ 等）就**无法**组合出指向那个方向的“d成分”。
    *   **SVD 强行拟合**: 为了最小化误差，SVD 会强行扭曲系数，导致成分分配完全乱套。

### 2.3. 瑕疵案例：sp3d2 (Octahedral)
*   **输入**: $s, p_z, p_x, p_y, d_{z^2}, d_{x^2-y^2}$
*   **实测结果**:
    *   s 成分稳定 (~16.7%)。
    *   p/d 成分有波动 (p: 46%-53%, d: 30%-36%)。
    *   指向大致正确（八面体）。
*   **分析**: 
    *   虽然比 sp3d 好，也存在旋转对齐问题。标准八面体场通常假设沿轴向，$d_{z^2}$ 和 $d_{x^2-y^2}$ 分别对应轴向和平面轴。
    *   如果 Thomson 八面体旋转了 45 度，需要的 d 轨道可能是 $d_{xy}$ 等，但基组里没有。于是只能用 $p$ 轨道去凑，或者牺牲正交性。

## 3. 算法缺陷深度剖析

当前流程：
1.  **Generate Shape**: 生成 N 个排斥力最小的点 (Thomson Problem) -> 得到几何构型（四面体、TBP 等）。
2.  **Sample Basis**: 计算基函数在这些点上的值矩阵 $A$。
3.  **Orthogonalize**: 对 $A$ 进行 SVD 分解得到系数。

**致命伤**: 第 1 步生成的形状是**随机旋转**的，没有考虑第 2 步中基函数的**固有对称轴**。

*   对于 $sp^3$，基组是球对称的（s）+ 矢量全空间（px,py,pz），所以形状怎么转都没事。
*   对于 $sp^3d$，基组包含“Z轴专用”的 $d_{z^2}$。如果第一步生成的 TBP 轴向不是 Z 轴，基组就无法物理地匹配该形状。

## 4. 建议方向 (Draft)

目前只是分析，不进行修复。但为了记录，未来的修复方案应包括：
*   **强制对齐**: 在生成 Thomson 点后，必须将其“对齐”到基组的主轴（例如将 TBP 的轴向强制旋转到 Z 轴）。
*   **对称性构建**: 对于 sp3d/sp3d2，直接使用硬编码的标准方向（如 $+Z, -Z, +X, -X, +Y, -Y$），而不是运行随机的 Thomson 优化。
*   **群论方法**: 真正的杂化应该基于对称性匹配（SALCs），而不是几何拟合。
